$def with (params, text, user, websocket_url)
$var title: SendARobot
$var jsfiles:
$var params: $:params




<script>
    function leave_state(s) {
        $$('#call_btn').removeAttr('onclick');
        $$('#call_btn').prop('disabled', true);
        $$('#call_btn').html("");
        $$('#call_btn').removeClass('btn-success btn-danger btn-warning btn-default btn-primary');
        switch(s) {
            case 'ACCEPTED':
            case 'BUTTON':
            case 'ARRIVED':
            case 'LOADED':
            case 'DELIVERED':
            case 'CALLED':
            case 'INIT':
            default:
                break;
        }

    }

    function enter_state(s) {
        $$('#call_btn').prop('disabled', false);
        switch(s) {
            case 'ACCEPT':
                $$('#call_btn').html("$:text('Robot is on its way.<br/> Click to cancel')");
                $$('#call_btn').attr(
                    'onClick',
                    "send({'method':'cancel', 'user': user});"
                );
                break;
            case 'ARRIVED':
                $$('#call_btn').html("$:text('Robot is here.<br/>Load it and click here.')");
                $$('#call_btn').attr(
                    'onClick',
                    "send({'method':'set_state', 'user': user, 'state': 'LOADED'});"
                );
                $$('#call_btn').addClass('btn-success');
                break;
            case 'BUTTON':
            case 'CALLED':
                $$('#call_btn').html("$:text('Robot is called.<br/> Click to cancel')");
                $$('#call_btn').attr(
                    'onClick',
                    "send({'method':'cancel', 'user': user});"
                );
                $$('#call_btn').addClass('btn-warning');
                break;
            case 'LOADED':
                $$('#call_btn').html("$:text('Robot will drive off.')");
                break;
            case 'DELIVERED':
            case 'INIT':
            default:
                $$('#call_btn').html("$text('Call a robot')");
                $$('#call_btn').attr(
                    'onClick',
                    "send({'method':'call', 'user': user});"
                );
                $$('#call_btn').addClass('btn-primary');
        }

    }

    function transition(new_state) {
        if (new_state != state) {
            console.log('old state: ' + state);
            leave_state(state);
            state = new_state;
            enter_state(state);
            console.log('new state: ' + state);
        } else {
            console.log('staying in state: ' + state)
        }
    }

    function _update_orders(data) {
        var states = data['states'];
        for(var key in states) {
            if (key == user) {
                transition(states[key]);
            }
        }
    }

    function _set_state(s) {
        transition(s['state']);
    }

    function query_state(u){
        send({
            'method':'get_state',
            'user': user,
        });
    }

    function _update_position(data) {
    }

    function register() {
        send({
            'method':'register',
            'admin': false,
            'user': '$user'
        });
        console.log("registered!");
    }

    // globals
    latitude = -1;
    longitude = -1;
    accuracy = -1;
    row='';

    state = '';
    user = '$user';


    document.onready = function() {
        webnsock_init('$websocket_url');
        defaultVariables();
        socket.onopen = function () {
            console.log("Connected!");
            register();
            query_state(user);

            send({
                'method':'location_update',
                'row': row,
                'user': user,
                'latitude': latitude,
                'longitude': longitude,
                'accuracy': accuracy,
                'rcv_time': Date.now()
                // 'heading' : heading,
                // 'velocity' : speed
            });
        };
    }




    /* $$(".dropdown-menu li a").click(function(){
        $$(this).parents(".dropdown").find('.btn').html($$(this).text() + ' <span class="caret"></span>');
        $$(this).parents(".dropdown").find('.btn').val($$(this).data('value'));
    });
 */
</script>
<div style="padding-top:15px" class="section">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <form action="#" method="post">
                            <h3 style="font-size: 500%;" class="panel-title">User: $user  <button style="font-size: 75%;" class="btn btn-warning" type="submit">logout</button></h3>
                        </form>
                    </div>

                    <div class="panel-body">
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-success dropdown-toggle"
                                            type="button" id="dropdownMenu1"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Tunnel: <span class="tunnel_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu tunnel-dropdown-menu" style="width: 100%;" aria-labelledby="dropdownMenu1">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-success dropdown-toggle row_selection_btn"
                                            type="button" id="dropdownMenu2" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Row: <span class="row_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu row-dropdown-menu" style="width: 100%;" aria-labelledby="dropdownMenu2">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-success dropdown-toggle edge_selection_btn"
                                            type="button" id="dropdownMenu3" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Edge: <span class="edge_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu edge-dropdown-menu" style="width: 100%;" aria-labelledby="dropdownMenu3">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-warning dropdown-toggle"
                                            type="button" id="dropdownMenu4"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Select Task: <span class="task_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu task-dropdown-menu" style="width: 100%;" aria-labelledby="dropdownMenu4">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-warning dropdown-toggle robot_selection_btn"
                                            type="button" id="dropdownMenu5" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Select Robot:<br> <span class="robot_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu robot-dropdown-menu" style="width: 100%;" aria-labelledby="dropdownMenu5">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="" role="group">
                            <button style="font-size: 10vw; min-height: 35vh;"
                                    id="call_btn"
                                    onclick="send({
                                        'method':'call',
                                        'user': user,
                                        'row': row,
                                    });"
                                    class="btn btn-block btn-lg">$text('Begin Task')</button>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script>
var map
var robots
var task_type
var tunnel_id
var row_id
var edge_id

function defaultVariables() {
    tunnel_id = 'select'
    row_id = 'all'
    edge_id = 'all'
    map = getRasberryTopoMap()
    load_tunnels()


    task_type = 'select'
    robots = getRobots()
    load_tasks()

    console.log("default initialisation complete")
}


</script>

<script>
function getRasberryTopoMap() {
  let ca = decodeURIComponent(document.cookie).split('; ');
  let dict = {};
  for(let i = 0; i <ca.length; i++) {
    kv = ca[i].split('=');
    dict[kv[0]] = kv[1];
  }
  return JSON.parse(dict["_rasberry_topomap"].replaceAll("'","\""))
}

function getRobots() {
  let ca = decodeURIComponent(document.cookie).split('; ');
  let dict = {};
  for(let i = 0; i <ca.length; i++) {
    kv = ca[i].split('=');
    dict[kv[0]] = kv[1];
  }
  return JSON.parse(dict["_robots"].replaceAll("'","\""))
}
</script>

<script>

function load_tunnels() {
    $$('.tunnel-dropdown-menu')
        .append('<li style="font-size: 500%;" ><a href="#">select</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map).length; i++) {
        $$('.tunnel-dropdown-menu')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(map)[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".tunnel-dropdown-menu li a").click(tunnel_li_a_response);
    $$('.tunnel_selection_btn').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }

function load_rows() {
    empty_rows()
    $$('.row-dropdown-menu')
        .append('<li style="font-size: 500%;" ><a href="#">all</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map[tunnel_id]).length; i++) {
        $$('.row-dropdown-menu')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(map[tunnel_id])[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".row-dropdown-menu li a").click(row_li_a_response);
    $$('.row_selection_btn').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }

function load_edges() {
    empty_edges()
    $$('.edge-dropdown-menu')
        .append('<li style="font-size: 500%;" ><a href="#">all</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map[tunnel_id][row_id]).length; i++) {
        $$('.edge-dropdown-menu')
            .append('<li style="font-size: 500%;" ><a href="#">'+map[tunnel_id][row_id][i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".edge-dropdown-menu li a").click(edge_li_a_response);
    $$('.edge_selection_btn').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }




function load_tasks() {
    for (let i = 0; i < Object.keys(robots['tall']).length; i++) {
        $$('.task-dropdown-menu')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(robots['tall'])[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".task-dropdown-menu li a").click(task_li_a_response);
    $$('.task_selection_btn').prop("disabled", false).removeClass("btn-outline-warning").addClass("btn-warning"); }

function load_robots() {
    empty_robots()
    $$('.robot-dropdown-menu')
        .append('<li style="font-size: 500%;" ><a href="#">closest</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(robots['tall'][task_type]).length; i++) {
        $$('.robot-dropdown-menu')
            .append('<li style="font-size: 500%;" ><a href="#">'+robots['tall'][task_type][i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".robot-dropdown-menu li a").click(robot_li_a_response);
    $$('.robot_selection_btn').prop("disabled", false).removeClass("btn-outline-warning").addClass("btn-warning"); }


</script>

<script>

function empty_rows() {     $$('.row-dropdown-menu').empty();   $$('.row_selection_btn').prop("disabled", true).addClass("btn-outline-success").removeClass("btn-success");}
function empty_edges() {   $$('.edge-dropdown-menu').empty();  $$('.edge_selection_btn').prop("disabled", true).addClass("btn-outline-success").removeClass("btn-success");}
function empty_robots() { $$('.robot-dropdown-menu').empty(); $$('.robot_selection_btn').prop("disabled", true).addClass("btn-outline-warning").removeClass("btn-warning");}


</script>

<script>

function tunnel_li_a_response(){
    $$('.tunnel_selection').text($$(this).text());
    $$('.tunnel_selection').val($$(this).text());
    $$('.row_selection').text("all");
    $$('.row_selection').val("all");
    $$('.edge_selection').text("");
    $$('.edge_selection').val("");
    console.log('new tunnel: ' + $$('.tunnel_selection').val());
    tunnel_id = $$('.tunnel_selection').val()
    if ($$('.tunnel_selection').val() != 'select') {
        load_rows()
    } else {
        $$('.row_selection').text("");
        $$('.row_selection').val("");
        $$('.edge_selection').text("");
        $$('.edge_selection').val("");
        empty_rows()
    }
    empty_edges()
}

function row_li_a_response() {
    $$('.row_selection').text($$(this).text());
    $$('.row_selection').val($$(this).text());
    $$('.edge_selection').text("all");
    $$('.edge_selection').val("all");
    console.log('new row: ' + $$('.row_selection').val());
    row_id = $$('.row_selection').val()
    if ($$('.row_selection').val() != 'all') {
        load_edges()
    } else {
        $$('.edge_selection').text("");
        $$('.edge_selection').val("");
        empty_edges()
    }
}

function edge_li_a_response() {
    $$('.edge_selection').text($$(this).text());
    $$('.edge_selection').val($$(this).text());
    console.log('new edge: ' + $$('.edge_selection').val());
}

function task_li_a_response() {
    $$('.task_selection').text($$(this).text());
    $$('.task_selection').val($$(this).text());
    $$('.robot_selection').text("closest");
    $$('.robot_selection').val("closest");
    console.log('new task: ' + $$('.task_selection').val());
    task_type = $$('.task_selection').val()
    if ($$('.task_selection').val() != 'select') {
        load_robots()
    } else {
        empty_robots()
    }
}

function robot_li_a_response() {
    $$(this).parents(".btn-group").find('.robot_selection').text($$(this).text());
    $$(this).parents(".btn-group").find('.robot_selection').val($$(this).text());
    console.log('new robot: ' + $$('.robot_selection').val());
}

</script>

