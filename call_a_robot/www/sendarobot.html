$def with (params, text, user, websocket_url)
$var title: SendARobot
$var jsfiles:
$var params: $:params

<script>

    function update_begin_button(s) {
        if (s == 'sar_BEGIN' || s == 'INIT' || s == 'sar_INIT') {
            if (tunnel_id=="select" || task_type=="select") {
                $$('#main_btn').html('Select a tunnel <br/>and task type');
                $$('#main_btn').prop('disabled', true);
                $$('#main_btn').removeClass('btn-primary');
            } else {
                $$('#main_btn').html('Make Request');
                $$('#main_btn').attr('onClick', "send({'method':'sar_begin_task', 'user': user, 'tunnel':tunnel_id, 'row':row_id, 'edge':edge_id, 'task':task_type, 'robot':robot_id});");
                $$('#main_btn').addClass('btn-primary');
                $$('#main_btn').prop('disabled', false);
            }
        }
    }

    let non_emergency = '';
    function move_state(s) {
        $$('#main_btn').html("");
        $$('#main_btn').prop('disabled', false);
        $$('#main_btn').removeAttr('onclick');
        $$('#main_btn').removeClass('btn-success btn-danger btn-warning btn-default btn-primary');

        switch(s.split('-')[0]) {
            case 'sar_EMERGENCY_STOP':
                $$('#emergency_btn').html("Click to Resume");
                $$('#emergency_btn').attr('onClick', "send({'method':'sar_emergency_resume', 'user': user});");

                $$('#main_btn').html("EMERGENCY<br/>PAUSE");
                main_btn_mod('cancel task', 'danger', 'sar_cancel_task');

                non_emergency = state;
                break;

            case 'sar_EMERGENCY_RESUME':
                s = non_emergency;
            case 'sar_CANCEL':
                $$('#emergency_btn').html("Emergency Stop");
                $$('#emergency_btn').attr('onClick', "send({'method':'sar_emergency_stop', 'user': user});");
                non_emergency = '';
                break;
        }

        switch(s.split('-')[0]) {
            case 'sar_EMERGENCY_STOP':
                break;

            case 'sar_EMERGENCY_RESUME':
                break;

            case 'INIT':
            case 'sar_INIT':
                $$('#main_btn').html('Select a tunnel <br/>and task type.');
                $$('#main_btn').prop('disabled', true);
                activateRequiredDropdowns();
                update_begin_button(s);
                break;

            case 'sar_BEGUN':
                $$('#main_btn').html('Awaiting server<br/>confirmation.');
                main_btn_mod('cancel', 'default', 'sar_cancel_task'); break;

            case 'sar_AWAIT_START':
                $$('#main_btn').html('Robot moving to<br/>start location.');
                main_btn_mod('cancel', 'default', 'sar_cancel_task'); break;

            case 'sar_AWAIT_TASK_COMPLETION':
                $$('#main_btn').html('Robot has begun<br/>'+task_type.replace('_',' ')+'.');
                main_btn_mod('cancel', 'primary', 'sar_cancel_task'); break;

            case 'sar_COMPLETE':
                $$('#main_btn').html('All task stages<br/>are complete.');
                main_btn_mod('reset', 'success', 'sar_init'); break;

            case 'sar_CANCEL':
                emergency_btn_reset();
                $$('#main_btn').html('TASK CANCELLED');
                main_btn_mod('reset', 'danger', 'sar_init'); break;

            case 'sar_CANCEL_REMOTE':
                emergency_btn_reset();
                $$('#main_btn').html('TASK CANCELLED<br/>REMOTELY');
                main_btn_mod('reset', 'default', 'sar_init'); break;

            default:
                $$('#main_btn').html("STATE Error");
                $$('#main_btn').addClass('btn-dark');
                break;
        }
        return s
    }

    function emergency_btn_reset() {
        $$('#emergency_btn').html("Emergency Stop");
        non_emergency = '';
        paused = false;
    }

    function main_btn_mod(txt, cls, method) {
        $$('#main_btn').html($$('#main_btn').html()+'<br/><br/>Click to '+txt+'.')
        $$('#main_btn').addClass('btn-'+cls);
        $$('#main_btn').attr('onClick', "send({'method':'"+method+"', 'user': user});");
        disableDropdowns();
    }

    function transition(new_state) {
        if (new_state != state || new_state == "sar_EMERGENCY") { new_state=move_state(new_state); }
        state = new_state;
        //$$('.logout').html(new_state);
    }

    function _update_orders(data) {
        var states = data['states'];
        for(var key in states) { if (key == user) { transition(states[key]); } }
    }

    function register() { send({ 'method':'register', 'admin': false, 'user': '$user' }); console.log("registered!"); }

    function query_state(u){ send({ 'method':'get_state', 'user': user, }); }
    function _set_state(s) { transition(s['state']); }


    // globals
    state = '';
    user = '$user';

    document.onready = function() {
        webnsock_init('$websocket_url');
        defaultVariables();
        socket.onopen = function () {
            console.log("Connected!");
            register();
            query_state(user);
        };
    }
</script>

<div style="padding-top:15px" class="section">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <form action="#" method="post">
                            <h3 style="font-size: 500%;" class="panel-title">User: $user
                                <button style="font-size: 63%; float: right;" class="btn btn-warning logout" type="submit">logout</button>
                            </h3>
                        </form>
                    </div>

                    <div class="panel-body">
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-success dropdown-toggle tunnel_sb"
                                            type="button" id="dropdownMenu1"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Tunnel: <span class="tunnel_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu tunnel-ddm" style="width: 100%;" aria-labelledby="dropdownMenu1">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-success dropdown-toggle row_sb"
                                            type="button" id="dropdownMenu2" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Row: <span class="row_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu row-ddm" style="width: 100%;" aria-labelledby="dropdownMenu2">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-success dropdown-toggle edge_sb"
                                            type="button" id="dropdownMenu3" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Edge: <span class="edge_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu edge-ddm" style="width: 100%;" aria-labelledby="dropdownMenu3">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-warning dropdown-toggle task_sb"
                                            type="button" id="dropdownMenu4"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Select Task: <span class="task_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu task-ddm" style="width: 100%;" aria-labelledby="dropdownMenu4">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group btn-group-lg btn-group-justified" style="padding-bottom:5px" role="group">
                            <div class="btn-group btn-group-lg" role="group">
                                <div class="dropdown">
                                    <button style="font-size: 500%;" class="btn btn-lg btn-outline-warning dropdown-toggle robot_sb"
                                            type="button" id="dropdownMenu5" disabled=true
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Select Robot:<br> <span class="robot_selection"></span> <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu robot-ddm" style="width: 100%;" aria-labelledby="dropdownMenu5">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div class="" role="group">
                            <button style="font-size: 10vw; min-height: 35vh;"
                                    id="main_btn"
                                    onclick="send({ 'method':'sar_begin_task', 'user': user, 'row': row });"
                                    disabled=true
                                    class="btn btn-block btn-lg">Initialising...
                            </button>
                        </div>
                    </div>

                    <div class="panel-body">
                        <div role="group">
                            <button style="font-size: 10vw; min-height: 10vh;"
                                    id="emergency_btn"
                                    onclick="send({ 'method':'sar_emergency_stop', 'user': user });"
                                    class="btn btn-block btn-lg btn-danger">Emergency Stop</button>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<script>
var map
var robots

var tunnel_id
var row_id
var edge_id

var task_type
var robot_id

function defaultVariables() {
    tunnel_id = 'select'
    row_id = 'all'
    edge_id = 'all'
    map = getRasberryTopoMap()
    load_tunnels()

    task_type = 'select'
    robot_id = 'closest'
    robots = getRobots()
    load_tasks()

    console.log("default initialisation complete")
}

function activateRequiredDropdowns() {
    $$('.tunnel_sb').prop("disabled", false)
    $$('.row_sb').prop("disabled", $$('.tunnel_selection').val() == 'select' || $$('.tunnel_selection').val() == '')
    $$('.edge_sb').prop("disabled", $$('.row_selection').val() == 'all' || $$('.row_selection').val() == '')
    $$('.task_sb').prop("disabled", false)
    $$('.robot_sb').prop("disabled", $$('.task_selection').val() == 'select' || $$('.task_selection').val() == '')
}

function disableDropdowns() {
    $$('.tunnel_sb').prop("disabled", true)
    $$('.row_sb').prop("disabled", true)
    $$('.edge_sb').prop("disabled", true)
    $$('.task_sb').prop("disabled", true)
    $$('.robot_sb').prop("disabled", true)
}


</script>

<script>
function getRasberryTopoMap() {
  let ca = decodeURIComponent(document.cookie).split('; ');
  let dict = {};
  for(let i = 0; i <ca.length; i++) {
    kv = ca[i].split('=');
    dict[kv[0]] = kv[1];
  }
  return JSON.parse(dict["_rasberry_topomap"].replaceAll("'","\""))
}

function getRobots() {
  let ca = decodeURIComponent(document.cookie).split('; ');
  let dict = {};
  for(let i = 0; i <ca.length; i++) {
    kv = ca[i].split('=');
    dict[kv[0]] = kv[1];
  }
  return JSON.parse(dict["_robots"].replaceAll("'","\""))
}
</script>

<script>

function load_tunnels() {
    $$('.tunnel-ddm')
        .append('<li style="font-size: 500%;" ><a href="#">select</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map).length; i++) {
        $$('.tunnel-ddm')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(map)[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".tunnel-ddm li a").click(tunnel_li_a_response);
    $$('.tunnel_sb').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }

function load_rows() {
    empty_rows()
    $$('.row-ddm')
        .append('<li style="font-size: 500%;" ><a href="#">all</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map[tunnel_id]).length; i++) {
        $$('.row-ddm')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(map[tunnel_id])[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".row-ddm li a").click(row_li_a_response);
    $$('.row_sb').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }

function load_edges() {
    empty_edges()
    $$('.edge-ddm')
        .append('<li style="font-size: 500%;" ><a href="#">all</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(map[tunnel_id][row_id]).length; i++) {
        $$('.edge-ddm')
            .append('<li style="font-size: 500%;" ><a href="#">'+map[tunnel_id][row_id][i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".edge-ddm li a").click(edge_li_a_response);
    $$('.edge_sb').prop("disabled", false).removeClass("btn-outline-success").addClass("btn-success"); }




function load_tasks() {
    $$('.task-ddm')
        .append('<li style="font-size: 500%;" ><a href="#">select</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(robots['tall']).length; i++) {
        $$('.task-ddm')
            .append('<li style="font-size: 500%;" ><a href="#">'+Object.keys(robots['tall'])[i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".task-ddm li a").click(task_li_a_response);
    $$('.task_sb').prop("disabled", false).removeClass("btn-outline-warning").addClass("btn-warning"); }

function load_robots() {
    empty_robots()
    $$('.robot-ddm')
        .append('<li style="font-size: 500%;" ><a href="#">closest</a></li>')
        .append('<li role="separator" class="divider"></li>')
    for (let i = 0; i < Object.keys(robots['tall'][task_type]).length; i++) {
        $$('.robot-ddm')
            .append('<li style="font-size: 500%;" ><a href="#">'+robots['tall'][task_type][i]+'</a></li>')
            .append('<li role="separator" class="divider"></li>') }
    $$(".robot-ddm li a").click(robot_li_a_response);
    $$('.robot_sb').prop("disabled", false).removeClass("btn-outline-warning").addClass("btn-warning"); }


</script>

<script>

function empty_rows() {     $$('.row-ddm').empty();   $$('.row_sb').prop("disabled", true).addClass("btn-outline-success").removeClass("btn-success"); row_id='all'; }
function empty_edges() {   $$('.edge-ddm').empty();  $$('.edge_sb').prop("disabled", true).addClass("btn-outline-success").removeClass("btn-success"); edge_id='all'; }
function empty_robots() { $$('.robot-ddm').empty(); $$('.robot_sb').prop("disabled", true).addClass("btn-outline-warning").removeClass("btn-warning"); robot_id='closest'; }


</script>

<script>

function tunnel_li_a_response(){
    $$('.tunnel_selection').text($$(this).text());
    $$('.tunnel_selection').val($$(this).text());
    $$('.row_selection').text("all");
    $$('.row_selection').val("all");
    $$('.edge_selection').text("");
    $$('.edge_selection').val("");
    console.log('new tunnel: ' + $$('.tunnel_selection').val());
    tunnel_id = $$('.tunnel_selection').val()
    if ($$('.tunnel_selection').val() != 'select') {
        load_rows()
    } else {
        $$('.row_selection').text("");
        $$('.row_selection').val("");
        $$('.edge_selection').text("");
        $$('.edge_selection').val("");
        empty_rows()
    }
    empty_edges()
    update_begin_button(state)
}

function row_li_a_response() {
    $$('.row_selection').text($$(this).text());
    $$('.row_selection').val($$(this).text());
    $$('.edge_selection').text("all");
    $$('.edge_selection').val("all");
    console.log('new row: ' + $$('.row_selection').val());
    row_id = $$('.row_selection').val()
    if ($$('.row_selection').val() != 'all') {
        load_edges()
    } else {
        $$('.edge_selection').text("");
        $$('.edge_selection').val("");
        empty_edges()
    }
}

function edge_li_a_response() {
    $$('.edge_selection').text($$(this).text());
    $$('.edge_selection').val($$(this).text());
    edge_id = $$('.edge_selection').val()
    console.log('new edge: ' + $$('.edge_selection').val());
}

function task_li_a_response() {
    $$('.task_selection').text($$(this).text());
    $$('.task_selection').val($$(this).text());
    $$('.robot_selection').text("closest");
    $$('.robot_selection').val("closest");
    console.log('new task: ' + $$('.task_selection').val());
    task_type = $$('.task_selection').val()
    if ($$('.task_selection').val() != 'select') {
        load_robots()
    } else {
        empty_robots()
    }
    update_begin_button(state)
}

function robot_li_a_response() {
    $$(this).parents(".btn-group").find('.robot_selection').text($$(this).text());
    $$(this).parents(".btn-group").find('.robot_selection').val($$(this).text());
    robot_id = $$('.robot_selection').val()
    console.log('new robot: ' + $$('.robot_selection').val());
}

</script>

